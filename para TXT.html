<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Procesar Datos desde Portapapeles</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .controls { text-align: center; margin: 10px; }
    .controls label, .controls button, .controls input { margin: 5px; }
    .send-button { padding: 10px; }
    .error { color: red; text-align: center; }
    table { border-collapse: collapse; width: 80%; margin: 20px auto; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: right; font-size: 10px; }
    th { background: #eee; text-transform: uppercase; }
    td:first-child, th:first-child, td:nth-child(2), th:nth-child(2) { text-align: left; }
    tr:nth-child(even) { background-color: #f9f9f9; }
  </style>
</head>
<body>
  <h2>Procesar Datos desde Portapapeles</h2>
  <div class="controls">
    <label for="ticker">Ticker:</label>
    <input type="text" id="ticker" placeholder="Ej: MELI">
    <button onclick="processClipboardData()">Procesar Datos</button>
    <button class="send-button" onclick="enviarDatos()" disabled>Enviar datos a la hoja</button>
  </div>
  <div id="output" class="error"></div>
  <table id="historicalTable">
    <thead id="tableHead"></thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script>
    let historicalData = [];

    function extractTableHtml(text) {
      const tableStart = text.indexOf('<table');
      if (tableStart === -1) return null;
      const tableEnd = text.indexOf('</table>', tableStart);
      return tableEnd === -1 ? null : text.substring(tableStart, tableEnd + 8);
    }

    function parseTableFromTxt(tableHtml, ticker) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(tableHtml, 'text/html');
      const table = doc.querySelector('table');
      if (!table) return [];
      const rows = table.querySelectorAll('tr');
      const data = [];
      rows.forEach((row) => {
        const cells = row.querySelectorAll('td');
        if (cells.length === 7) {
          let dateText = cells[0].textContent.trim();
          const dateMatch = dateText.match(/(\w+)\s(\d+),\s(\d+)/);
          let dateFormatted = dateMatch
            ? `${dateMatch[3]}/${{jan:'01',feb:'02',mar:'03',apr:'04',may:'05',jun:'06',jul:'07',aug:'08',sep:'09',oct:'10',nov:'11',dec:'12'}[dateMatch[1].toLowerCase()]}/${dateMatch[2].padStart(2,'0')}`
            : null;
          if (!dateFormatted) return;
          const values = Array.from(cells).slice(1).map(cell =>
            parseFloat(cell.textContent.trim().replace(/,/g, ''))
          );
          if (values.every(v => !isNaN(v))) {
            data.push([ticker, dateFormatted, ...values.map(v => v.toFixed(2).replace('.', ','))]);
          }
        }
      });
      return data.sort((a, b) => new Date(a[1]) - new Date(b[1]));
    }

    async function processClipboardData() {
      const ticker = document.getElementById('ticker').value.trim().toUpperCase();
      const output = document.getElementById('output');
      const thead = document.getElementById('tableHead');
      const tbody = document.getElementById('tableBody');

      if (!ticker) {
        output.textContent = 'Ingresa un ticker válido.';
        return;
      }

      try {
        const clipboardText = await navigator.clipboard.readText();
        if (!clipboardText) {
          output.textContent = 'Portapapeles vacío. Copia el HTML desde view-source.';
          return;
        }

        const tableHtml = extractTableHtml(clipboardText);
        if (!tableHtml) {
          output.textContent = 'No se encontró tabla válida.';
          return;
        }

        historicalData = parseTableFromTxt(tableHtml, ticker);
        if (historicalData.length > 0) {
          const headers = ['Ticker', 'Fecha', 'Open', 'High', 'Low', 'Close', 'Adj Close', 'Volume'];
          thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
          tbody.innerHTML = '';
          historicalData.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = row.map(cell => `<td>${cell}</td>`).join('');
            tbody.appendChild(tr);
          });
          document.querySelector('.send-button').disabled = false;
          output.textContent = 'Datos procesados. Verifica la tabla.';
        } else {
          output.textContent = 'No se pudieron procesar datos.';
        }
      } catch (err) {
        output.textContent = 'Error: ' + err.message;
      }
    }

    async function enviarDatos() {
      const output = document.getElementById('output');
      output.textContent = 'Enviando tabla...';

      try {
        const response = await fetch('https://script.google.com/macros/s/AKfycbxsNqW0FGtgDdMSFzXMAOKKO7bb1bwxffUpkqCoTR6w_oLarKzU-zPwAdnlNQZ-UZki0Q/exec', {
          method: 'POST',
          body: JSON.stringify({ datos: historicalData }),
          headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.text();
        output.textContent = result.includes('OK') ? 'Tabla enviada.' : result;
      } catch (err) {
        output.textContent = 'Error al enviar: ' + err.message;
      }
    }
  </script>
</body>
</html>